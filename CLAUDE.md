# Challenge Backend

## Project Overview
- **Name**: challenge-backend
- **Type**: FastAPI serverless backend
- **Runtime**: Python 3.12
- **Framework**: FastAPI + Mangum (for AWS Lambda)
- **Deployment**: AWS Serverless (using Serverless Framework)

## Project Structure
```
challenge-backend/
├── main.py                  # FastAPI application entry point (root level)
├── __init__.py              # Makes root a Python package
├── app/                     # Application code
│   ├── __init__.py
│   ├── api/                 # API endpoints
│   │   └── __init__.py
│   ├── common/              # Common utilities
│   │   ├── __init__.py
│   │   └── enums.py         # Environment and other enums
│   ├── database/            # Database configuration
│   │   ├── __init__.py
│   │   ├── config.py        # Database connection setup
│   │   ├── constant.py      # Database constants
│   │   └── dependency.py    # Database dependency injection
│   └── module/              # Business logic modules
│       └── __init__.py
├── infra/
│   ├── package.json         # Serverless plugin dependencies
│   ├── package-lock.json
│   └── serverless.yml       # Serverless Framework configuration
├── .pre-commit-config.yaml  # Pre-commit hooks configuration
├── Dockerfile               # Docker containerization
├── docker-compose.yml       # Docker Compose configuration
├── pyproject.toml           # Python project configuration
├── requirements.txt         # Python dependencies (auto-generated by uv)
├── uv.lock                  # UV lockfile
├── CLAUDE.md               # Project documentation
└── README.md
```

## Technology Stack
- **Python**: 3.12+
- **Web Framework**: FastAPI 0.116.1
- **ASGI Adapter**: Mangum 0.19.0 (for AWS Lambda)
- **ASGI Server**: Uvicorn 0.35.0
- **Database**:
  - SQLAlchemy 2.0.43 (Async ORM)
  - Alembic 1.16.5 (Database migrations)
  - MySQL (async driver)
- **Package Manager**: UV
- **Infrastructure**: Serverless Framework
- **Cloud Provider**: AWS (ap-northeast-2 region)
- **Code Quality Tools**:
  - Black (Code formatter)
  - isort (Import sorter)
  - Flake8 (Linter)
  - MyPy (Type checker)
  - Pre-commit hooks

## Development Commands

### Python Environment
```bash
# Install dependencies
uv sync

# Run locally (development) - main.py is in root directory
uv run uvicorn main:app --host 0.0.0.0 --port 8000 --reload

# Run with custom port
uv run uvicorn main:app --host 0.0.0.0 --port 3000 --reload

# Add new dependency
uv add <package-name>
```

### Docker Commands
```bash
# Build Docker image
docker build -t backend:latest .

# Run with Docker Compose
docker-compose up -d

# Run Docker container directly
docker run -p 8000:8000 backend:latest
```

### Serverless Deployment

#### Environment Setup
```bash
# .env 파일 생성 (.env.example 참고)
cp .env.example .env

# 필수 환경변수 설정
export DB_NAME=challenge
export DB_USER=root
export DB_PASSWORD=your_secure_password
export SERVERLESS_ORG=your_org_name
```

#### Manual Deployment
```bash
# Install serverless dependencies
cd infra && npm install

# Deploy to dev stage (환경변수 필요)
cd infra && make deploy-dev

# Deploy to production stage (환경변수 필요)
cd infra && make deploy-prod

# Remove deployment
cd infra && make remove-dev
cd infra && make remove-prod
```

#### Automated Deployment (CI/CD)
- **Dev → Prod**: PR merge to `main` branch automatically deploys to production
- **Versioning**: `v2024.09.02-abc1234` format (date + commit hash)
- **GitHub Release**: Automatically created with deployment info
- **Health Check**: Automatic API health validation after deployment

**Required GitHub Secrets:**
- `AWS_ACCESS_KEY_ID`: AWS access key
- `AWS_SECRET_ACCESS_KEY`: AWS secret key
- `SERVERLESS_ACCESS_KEY`: Serverless Framework access token
- `SERVERLESS_ORG`: Serverless organization name

## API Endpoints
- `GET /health` - Health check endpoint

## Database Architecture
- **Environment-based Configuration**: Database URL is determined by ENVIRONMENT variable
- **Connection Pooling**:
  - Pool size: Configurable via constants
  - Max overflow: Configurable via constants
  - Pool timeout: Configurable timeout for pool connections
  - Connection timeout: Configurable timeout for database connections
- **Async Support**: Uses SQLAlchemy async engine with async_sessionmaker

## Configuration
- **AWS Region**: ap-northeast-2 (Seoul)
- **Default Stage**: dev
- **Lambda Handler**: ../src/main.handler
- **Python Requirements**: Uses Docker for pip installation
- **Required Environment Variables**:
  - `DB_NAME`: 데이터베이스 이름 (기본값: challenge)
  - `DB_USER`: 데이터베이스 사용자 (기본값: root)
  - `DB_PASSWORD`: 데이터베이스 비밀번호 (필수, 기본값 없음)
  - `ENVIRONMENT`: 환경 구분 (dev/prod)
  - `SERVERLESS_ORG`: Serverless Framework 조직명 (배포 시 필요)

## Important Notes
- SQLAlchemy async sessions require `async_sessionmaker` instead of regular `sessionmaker`
- Database configuration is centralized in `app/database/config.py`
- Environment validation ensures only valid environment types are used

## AI Assistant Instructions (한국어 응답)
이 프로젝트에서 작업할 때는 다음 지침을 따르세요:
1. **언어**: 모든 응답은 한국어로 작성합니다.
2. **코드 스타일**: Black, isort 포맷터 규칙을 따릅니다 (line-length: 120).
3. **타입 힌팅**:
   - 가능한 모든 곳에 타입 힌팅을 사용합니다.
   - **IMPORTANT**: Python 3.11+ 내장 타입을 사용하고 `typing` 모듈은 사용하지 않습니다.
   - ✅ 올바른 예시: `list[str]`, `dict[str, int]`, `tuple[str, ...]`
   - ❌ 잘못된 예시: `typing.List[str]`, `typing.Dict[str, int]`, `typing.Tuple[str, ...]`
   - 예외: `typing` 모듈에서만 제공되는 특수 타입 (예: `Protocol`, `TypeVar` 등)은 사용 가능
4. **비동기 프로그래밍**: FastAPI와 SQLAlchemy는 모두 async/await 패턴을 사용합니다.
5. **에러 처리**: 명확한 에러 메시지를 한국어로 제공합니다.
6. **보안**: 환경 변수를 통해 민감한 정보를 관리합니다.
7. **Import 규칙**:
   - 모든 import 문은 파일 최상단에 위치합니다.
   - 함수/메소드 내부에서 import 하지 않습니다.
8. **주석 규칙**:
   - 불필요한 주석은 작성하지 않습니다.
   - 코드 자체가 명확하면 주석을 생략합니다.
   - Docstring은 복잡한 비즈니스 로직이나 public API에만 작성합니다.
9. **시간 처리 규칙** (`app/common/utils/time.py` 참조):
   - **IMPORTANT**: DB에 저장되는 모든 datetime은 UTC로 통일합니다.
   - 사용자에게 표시되는 모든 시간은 KST(한국 시간) 기준입니다.
   - 시간 변환 시 반드시 `TimeConverter` 클래스 또는 헬퍼 함수를 사용합니다:
     - `utc_now()`: 현재 UTC 시간 (DB 저장용)
     - `kst_now()`: 현재 KST 시간 (비즈니스 로직용)
     - `to_utc(dt)`: KST → UTC 변환 (DB 저장 전)
     - `to_kst(dt)`: UTC → KST 변환 (DB 조회 후)
   - 날짜 비교 시 항상 timezone을 고려합니다.
   - **절대 naive datetime을 사용하지 않습니다** (tzinfo 없는 datetime).
